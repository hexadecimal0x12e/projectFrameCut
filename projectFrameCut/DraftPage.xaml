<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"  
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"  
             xmlns:vm="clr-namespace:projectFrameCut.ViewModels"
             xmlns:conv="clr-namespace:projectFrameCut.Converters"
             x:Class="projectFrameCut.DraftPage"
             x:Name="MainPageRoot"
             Title="default draft page">
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Render" Clicked="OnExportDraft" Order="Primary" Priority="0" />
        <ToolbarItem Text="Options"/>
    </ContentPage.ToolbarItems>

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:SecondsToPixelsConverter x:Key="SecondsToPixelsConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <!-- Add a dedicated row for the ruler above the scrollable tracks -->
    <Grid RowDefinitions="Auto,Auto,*,Auto,250">
        <!-- Toolbar -->
        <ScrollView Orientation="Horizontal">
            <HorizontalStackLayout Padding="8" Spacing="8" Grid.Row="0">
               <!-- <Button Text="导出" Clicked="OnExportDraft" />
                <Button Text="导入" Clicked="OnImportDraft" />
                
                <Button Text="Add Clip" Clicked="OnAddClip" />-->
                <Button Text="Add Track" Clicked="OnAddTrack" />
                <Button Text="Split" Clicked="OnSplitClip" />
                <Button Text="Delete" Clicked="OnDeleteClip" />
                <Button Text="-" Clicked="OnZoomOut" />
                <Button Text="+" Clicked="OnZoomIn" />
            </HorizontalStackLayout>
        </ScrollView>
        <!-- Ruler row aligned with timeline (outside ScrollView so it doesn't affect content width) -->
        <Grid Grid.Row="1" ColumnDefinitions="140,*">
            <!-- Left gutter to align with track headers width -->
            <BoxView Grid.Column="0" WidthRequest="140" Color="Transparent" />
            <!-- Ruler area -->
            <Grid Grid.Column="1" BackgroundColor="#222" HeightRequest="24">
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnRulerTapped" />
                </Grid.GestureRecognizers>
                <AbsoluteLayout x:Name="Ruler" />
            </Grid>
        </Grid>

        <!-- Tracks & Timeline -->
        <ScrollView x:Name="TimelineScroll" Grid.Row="2" Orientation="Both" Scrolled="OnTimelineScrolled">
            <!-- Make second column Auto so it can grow wider than viewport -->
            <Grid x:Name="TimelineGrid" ColumnDefinitions="Auto,Auto" RowSpacing="0">
                <!-- Track headers -->
                <VerticalStackLayout x:Name="TracksHeader" WidthRequest="140" BackgroundColor="LightGray" Spacing="1" />

                <!-- Timeline canvas sized by TimelineWidth to enable horizontal scroll -->
                <Grid Grid.Column="1" x:Name="TimelineCanvas" WidthRequest="{Binding TimelineWidth}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Tracks area -->
                    <VerticalStackLayout Grid.Row="0" x:Name="TracksPanel" Spacing="1" />

                    <!-- Playhead line -->
                    <BoxView x:Name="Playhead" Color="Red" WidthRequest="2" HorizontalOptions="Start" VerticalOptions="Fill" />
                </Grid>
            </Grid>
        </ScrollView>

        <Grid Grid.Row="3">
            <Label  x:Name="Status" Padding="8" />

        </Grid>

        <!-- Status bar -->

        <!-- Preview & asset area -->
        <Grid Grid.Row="4" BackgroundColor="#111">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1*" />
                    <ColumnDefinition Width="2*" />
                </Grid.ColumnDefinitions>
                <!-- Asset library panel -->
                <Border Grid.Column="0" StrokeThickness="5" Padding="4" >
                    <Grid RowDefinitions="Auto,*">
                        <HorizontalStackLayout Spacing="8" Padding="0,0,0,4">
                            <Button Text="添加素材" Clicked="OnAddAsset" />
                            <Label Text="素材库" VerticalOptions="Center" FontAttributes="Bold" />
                        </HorizontalStackLayout>
                        <CollectionView Grid.Row="1"
                                        ItemsSource="{Binding Source={x:Reference MainPageRoot}, Path=Assets}"
                                        SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*,Auto" Padding="4" Margin="0,2">
                                        <Label Text="{Binding Icon}" FontSize="16" />
                                        <Label Grid.Column="1" Text="{Binding Name}" LineBreakMode="TailTruncation" />
                                        <Button Grid.Column="2" Text="+" Padding="0" WidthRequest="32" HeightRequest="28"
                                                Clicked="OnAddAssetToTimeline" CommandParameter="{Binding .}" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>
                </Border>
                <!-- Preview placeholder -->
                <Border Grid.Column="2" StrokeThickness="5" Padding="4" >
                    <Label Text="Preview placeholder" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />

                </Border>
                
            </Grid>
        </Grid>
    </Grid>
</ContentPage>